---
# Ergatis Component Documentation
# Extracted from source by extract_component_docs.pl
# Source: TIGR/JCVI/IGS Ergatis bioinformatics workflow system
#
# This file preserves ALL documentation, comments, parameter descriptions,
# and structural details from the original Ergatis source files.

component: adjust_bsml_coordinates
extracted_at: "2026-02-19T15:34:47"
source_files:
  - adjust_bsml_coordinates.config
  - adjust_bsml_coordinates.xml
  - adjust_bsml_coordinates.i1.xml
  - workflow/adjust_bsml_coordinates-master.ini
  - workflow/adjust_bsml_coordinates.ini
  - workflow/adjust_bsml_coordinatesconf.ini

# Configuration file - all sections, parameters, defaults, and inline comments
config:
  interface:
    classification: utility
  parameters:
    # Directory containing BSML map files (made by split_fasta)
    MAP_DIR: ""
    # List of all fragments from input assembl(y|ies)
    # Usually the same as the input file list
    BSML_LIST: $;INPUT_FILE_LIST$;
  input:
    INPUT_FILE_LIST: ""
    INPUT_FILE: ""
    INPUT_DIRECTORY: ""
    # the following is only used when iterating over an INPUT_DIRECTORY
    INPUT_EXTENSION: fsa
  output:
    OUTPUT_TOKEN: default
    OUTPUT_DIRECTORY: $;REPOSITORY_ROOT$;/output_repository/$;COMPONENT_NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    BSML_OUTPUT_LIST: $;OUTPUT_DIRECTORY$;/$;COMPONENT_NAME$;.bsml.list
  component:
    COMPONENT_NAME: adjust_bsml_coordinates
    DESCRIPTION: none
    WORKFLOW_REPOSITORY: $;REPOSITORY_ROOT$;/workflow/runtime/$;COMPONENT_NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    PIPELINE_TOKEN: unnamed
    # The version,revision,tag here is set by an interpolated CVS tag
    VERSION: $Name$
    RELEASE_TAG: $Name$
    REVISION: $Revision$
    TEMPLATE_XML: $;DOCS_DIR$;/$;COMPONENT_NAME$;.xml
    ITERATOR1: i1
    ITERATOR1_XML: $;DOCS_DIR$;/$;COMPONENT_NAME$;.$;ITERATOR1$;.xml
    # Distributed options
    GROUP_COUNT: 150
    NODISTRIB: 0
    # the following keys are replaced at runtime by the invocation script
    COMPONENT_CONFIG: ""
    COMPONENT_XML: ""
    PIPELINE_XML: ""
    PIPELINEID: ""
  include:
    PROJECT_CONFIG: ""

# Main workflow XML template - step definitions
workflow_xml:
  xml_comments:
    - Preprocessing
    - Processing
    - Iterator
    - Postprocessing
  command_sets:
    - split_multifasta workflow
  includes:
    - "file=\"$;DOCS_DIR$;/file_iterator_template.xml\" keys=\"$;ITERATOR_NAME$;=ITERATOR1,$;ITERATOR_XML$;=ITERATOR1_XML\""
  steps:
    - name: create output directory
      type: RunUnixCommand
      executable: mkdir
      arg: -p -m 777 $;OUTPUT_DIRECTORY$;
    - name: create temp directory
      type: RunUnixCommand
      executable: mkdir
      arg: -p -m 777 $;TMP_DIR$;
    - name: create bsml list
      type: RunUnixCommand
      executable: $;BIN_DIR$;/create_list_file
      params:
        - key: --regex
          value: "\".*.bsml\""
        - key: --directory
          value: $;OUTPUT_DIRECTORY$;
        - key: --output_list
          value: $;BSML_OUTPUT_LIST$;

# Iterator i1 - per-input processing steps
iterator_i1:
  command_sets:
    - split_multifasta compute
  steps:
    - name: adjust_bsml_coordinates
      type: RunUnixCommand
      executable: $;BIN_DIR$;/adjust_bsml_coordinates
      params:
        - key: --input_file
          value: $;I_FILE_PATH$;
        - key: --list_file
          value: $;BSML_LIST$;
        - key: --output_dir
          value: $;OUTPUT_DIRECTORY$;/i1/g$;GROUP_NUMBER$;
        - key: --map_dir
          value: $;MAP_DIR$;
        - key: --removed_log
          value: $;OUTPUT_DIRECTORY$;/i1/g$;GROUP_NUMBER$;/$;I_FILE_BASE$;_removed.log
    - name: dtd validation
      type: RunUnixCommand
      executable: $;BIN_DIR$;/dtdValid.pl
      arg: $;OUTPUT_DIRECTORY$;/$;ITERATOR_NAME$;/g$;GROUP_NUMBER$;/$;I_FILE_NAME$;
      params:
        - key: -d
          value: $;DOCS_DIR$;/bsml3_1.dtd

# Workflow INI: adjust_bsml_coordinates-master.ini
workflow_ini_adjust_bsml_coordinates-master.ini:
  create_bsml_list:
    param.command: $;BIN_DIR$;/create_list_file
    param.--regex: "\".*.bsml\""
    param.--directory: $;OUTPUT_DIRECTORY$;
    param.--output_list: $;BSML_OUTPUT_LIST$;
  create_compute_output:
    # make the output directory
    param.command: mkdir
    arg: -p -m 777 $;OUTPUT_DIRECTORY$;
  create_compute_scratch:
    # make the new scratch directory
    param.command: mkdir
    arg: -p -m 777 $;TMP_DIR$;
  create_groups_subflow1:
    param.command: $;BIN_DIR$;/generate_groups
    param.output_dir: $;WORKFLOW_REPOSITORY$;
    param.prefix: subflow1groups
    param.group_count: $;GROUP_COUNT$;
    param.file: $;WORKFLOW_REPOSITORY$;/subflow1.list
  create_iterative_subflow1:
    # create iterative subflow
    param.command: $;BIN_DIR$;/generate_subflow
    # workflow doc information
    param.template: $;WORKFLOWDOCS_DIR$;/groups-iterator_template.xml
    param.inifile: $;WORKFLOWDOCS_DIR$;/groups-iterator.ini
    param.iteratortemplate: $;WORKFLOWDOCS_DIR$;/batch-paralleliterator_template.xml
    param.iteratorini: $;WORKFLOWDOCS_DIR$;/batch-iterator.ini
    param.iteratorlist: $;WORKFLOW_REPOSITORY$;/subflow1groups.list
    param.conf: $;COMPONENT_CONFIG$;
    param.wfname: $;NAME$;
    param.nodistrib: $;NODISTRIB$;
    # output information
    param.outputdir: $;WORKFLOW_REPOSITORY$;
    param.outputxml: $;WORKFLOW_REPOSITORY$;/groups.xml
    param.debug: $;DEBUG$;
  create_iterator_list_subflow1:
    param.command: $;BIN_DIR$;/generate_input_list
    param.filelist: "'$;INPUT_FILE_LIST$;'"
    param.file: "'$;INPUT_FILE$;'"
    param.directory: "'$;INPUT_DIRECTORY$;'"
    param.extension: "'$;INPUT_EXTENSION$;'"
    param.output: $;WORKFLOW_REPOSITORY$;/subflow1.list
  empty:
  subflow1:
    fileName: $;WORKFLOW_REPOSITORY$;/groups.xml

# Workflow INI: adjust_bsml_coordinates.ini
workflow_ini_adjust_bsml_coordinates.ini:
  adjust_bsml_coordinates:
    # Execute the adjust_bsml_coordinates search
    param.command: $;BIN_DIR$;/adjust_bsml_coordinates
    param.--list_file: $;BSML_LIST$;
    param.--input_file: $;ITER_FILE_PATH$;
    param.--map_dir: $;MAP_DIR$;
    param.--removed_log: $;OUTPUT_DIRECTORY$;/$;GROUP_NAME$;/$;ITER_FILE_NAME$;_removed.log
    param.--output_dir: $;OUTPUT_DIRECTORY$;/$;GROUP_NAME$;
  dtd_validation:
    # perform document schema validation
    param.command: $;BIN_DIR$;/dtdValid.pl
    param.-d: $;SCHEMA_DIR$;/bsml3_1.dtd
    arg: $;OUTPUT_DIRECTORY$;/$;GROUP_NAME$;/$;ITER_FILE_NAME$;
  empty:

# Workflow INI: adjust_bsml_coordinatesconf.ini
workflow_ini_adjust_bsml_coordinatesconf.ini:
  _header:
    # configuration file for the adjust_bsml_coordinates workflow
  include adjust_bsml_coordinates:
    $;SHARED_CONFIG$;: ""
  input adjust_bsml_coordinates:
    $;INPUT_FILE_LIST$;: ""
    $;INPUT_FILE$;: ""
    $;INPUT_DIRECTORY$;: ""
    # the following is only used when iterating over an INPUT_DIRECTORY
    $;INPUT_EXTENSION$;: fsa
  output adjust_bsml_coordinates:
    $;OUTPUT_TOKEN$;: default
    $;OUTPUT_DIRECTORY$;: $;REPOSITORY_ROOT$;/output_repository/$;NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    $;BSML_OUTPUT_LIST$;: $;OUTPUT_DIRECTORY$;/$;NAME$;.bsml.list
  parameters adjust_bsml_coordinates:
    # Directory containing BSML map files (made by split_fasta)
    $;MAP_DIR$;: ""
    # List of all fragments from input assembl(y|ies)
    $;BSML_LIST$;: ""
  workflowdocs adjust_bsml_coordinates:
    $;VERSION$;: 1.0
    $;REVISION$;: $Revision$
    $;TAG$;: $Name$
    $;ALGORITHM$;: adjust_bsml_coordinates
    $;NAME$;: adjust_bsml_coordinates
    $;MASTER_TEMPLATE_INI$;: $;WORKFLOWDOCS_DIR$;/adjust_bsml_coordinates-master.ini
    $;MASTER_TEMPLATE_XML$;: $;WORKFLOWDOCS_DIR$;/adjust_bsml_coordinates-master_template.xml
    $;TEMPLATE_INI$;: $;WORKFLOWDOCS_DIR$;/adjust_bsml_coordinates.ini
    $;TEMPLATE_XML$;: $;WORKFLOWDOCS_DIR$;/adjust_bsml_coordinates_template.xml
    $;WORKFLOW_REPOSITORY$;: $;REPOSITORY_ROOT$;/Workflow/$;NAME$;/$;PIPELINEID$;_$;OUTPUT_TOKEN$;
    $;GROUP_COUNT$;: 150
    # the following keys are replaced at runtime by the invocation script
    $;COMPONENT_CONFIG$;: ""
    $;NODISTRIB$;: 0

# Perl script documentation (POD)
perl_scripts:
  - script: create_list_file.pl
    pod: |
  =head1	NAME
  
  create_list_file.pl - script to create a list of files given a certain regex
  
  =head1	SYNOPSIS
  
  USAGE: create_list_file.pl
         [  --directory|d=/path/to/some/directory/
            --output_list|o=/path/output.list
            --regex|r=string regular expression
            --include_gz|g ]
  
  =head1	OPTIONS
  
  B<--directory,-d>
  	Location of the directory to search.  No wild card characters should be
      used in the directory.
      (Default: current directory)
  
  B<--output_list,-o>
      File that will be the list of found files
      (Default: standard out)
  
  B<--regex,-r>
      Regular expression for entire file name (including full path)
      (Default: finds all files)
  
  B<--include_gz|g>
      This flag tells the script to include .gz extensions in the list
  
  B<--help,-h>
  	Prints this help message
  
  =head1	DESCRIPTION
  
      This script will search a directory for file names containing the given
      regular expression.  By default, all .gz or .gzip extensions are stripped
      off.  Programs using these list files should know to search for .gz|.gzip
      versions.
  
      **Note: No wild card characters should be used in this option.
  
  =head1	INPUT
  
      There are no required options to the script and there isn't really any
      input.  See above for defaults.  
  
  =head1	OUTPUT
  
      The script will output a list of files that match the regular expression
      given by option --regex|-r. If no output file is given, this script will 
      print out to standard out.  
  
  =head1	CONTACT
  
      Kevin Galens
      kgalens@tigr.org
  - script: adjust_bsml_coordinates.pl
    pod: |
  =head1  NAME 
  
  adjust_bsml_coordinates.pl - adjust the positional coordinates within a BSML file
  
  =head1 SYNOPSIS
  
  USAGE:  adjust_bsml_coordinates.pl
              --map_file=/path/to/somemapfile.bsml
              --map_dir=/or/path/to/somedir
              --list_file=/path/to/somefile.list
              --input_file=/paht/to/somefile.bsml
              --output_dir=/path/to/somedir
              --removed_log=/path/to/some/removed.log
            [ --filter_ends=1|0
              --debug=4
              --log=/path/to/somefile.log
            ]
  
  =head1 OPTIONS
  
  B<--map_file,-m> 
      Input BSML map file.
  
  B<--map_dir,-d> 
      Directory of input BSML map files.
  
  B<--list_file,-i> 
      Path to a list of analysis BSML output files.
  
  B<--input_file,-n>
      Path to the input file to be adjusted and searched for overlap
  
  B<--output_list,-u>
      Optional.  If passed, will create an output list with the full paths to each of the 
      BSML files created by this script.
  
  B<--output_dir,-o> 
      Directory where output BSML files will be written.
  
  B<--removed_log,-r>
      The log file where duplicate elements will be printed to after
      removal.
  
  B<--filter_ends,-f> 
      NOT YET IMPLEMENTED
  
  B<--debug,-d> 
      Debug level.  Use a large number to turn on verbose debugging. 
  
  B<--log,-l> 
      Log file
  
  B<--help,-h> 
      This help message
  
  =head1   DESCRIPTION
  
  Because some sequences are too large to be analyzed directly by some analysis tools, 
  it is sometimes necessary to first split those sequences into pieces, perform the 
  analysis on each fragment, and then stitch them back together. This last step causes 
  problems because any coordinates given in the result file will represent the 
  coordinates of the query in the fragment, and not be representative of the coordinates 
  of the original sequence.
  
  The purpose of this script is to read through the BSML results of such an analysis and 
  adjust the coordinates to reflect those in the original input file.  This is done using
  a set of BSML output files along with a mapping file.  Read the INPUT section for more
  information.
  
  Additionally, this script will search neighboring fragments of the input_file fragment
  and search for overlapping location specific predictions.  If a prediction is matched
  it is removed from the BSML file.  Also, if a location is contained completely within another,
  the smaller of the locations is removed.
  
  To use this component, you would most likely have used a splitting component previously
  in the pipeline, such as split_fasta, which generates the input maps.
  
  The list of attributes that are adjusted are defined within the script, and are currently
  refstart, refend, refpos, start, startpos, endpos, sitepos.
  
  =head1 INPUT
  
  Three types of input files are required to for this to work.  The first is a list of the
  BSML result files from an analysis, defined using --list_file.  The list file should
  look something like this:
  
      /some/path/cpa1.assem.1.0.aat_aa.bsml
      /some/path/cpa1.assem.1.1.aat_aa.bsml
      /some/path/cpa1.assem.1.10.aat_aa.bsml
      /some/path/cpa1.assem.1.11.aat_aa.bsml
  
  In this case, an aat_aa analysis was run on 4 sequences, probably named like cpa1.assem.1.0
  
  The BSML mapping file, passed with the --map_file option, gives information about how the
  coordinates in these files relate to the original non-split file, here named cpa1.assem.1
  
  If mapping information for the files in your list come from multiple BSML maps, you can use
  the --map_dir option.  This will load all maps in the specified directory whose names end
  in '.map.bsml'
  
  Also note this script handles compressed input.  If the input BSML files have been gzipped
  and end in either the '.gz' or '.gzip' extension, they will be decompressed, modified and
  recompressed on the fly.
  
  =head1 OUTPUT
  
  The output BSML files will be written to the directory specified by --output_dir.  You may
  specify the output_dir to be the same location as the original files to overwrite them.
  
  As each BSML file is analyzed, a few changes are made to reflect the coordinates back onto
  the non-fragmented sequence.  The following elements are searched and the attributes listed
  are modified:
  
      <Aligned-sequence> - start
      <Interval-loc> - startpos, endpos
      <Seq-pair-alignment> - refseq, refxref, refstart, refend
      <Seq-pair-run> - refpos
      <Site-loc> - sitepos
  
  In addition to these, any references to the fragment ID are changed back to the original
  sequence.  E.g.
  
      cpa1.assem.1.0  -->  cpa1.assem.1
  
  Also, an Analysis element is added to reflect that this script modified the file.
  
  Note that the file names, such as cpa1.assem.1.0.aat_aa.bsml, are not changed, though
  they no longer contain information directly concerning the fragment.  This way these
  sequences can be loaded as they are - else we would have to concatenate each of the
  fragmented files into one large BSML file before loading, which is not desirable.
  
  NOTE:  The BSML output currently has a return character between elements that are
  analyzed.  This is an artifact of XML::Twig's printing methods that I have yet to 
  resolve.  
  
  =head1 CONTACT
  
      Kevin Galens
      kgalens@tigr.org
  
      Joshua Orvis
      jorvis@tigr.org
